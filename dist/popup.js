const BASE_URL = 'https: document.addEventListener('DOMContentLoaded', async () => { const stateInput = document.getElementById('state-input'); const stateLoading = document.getElementById('state-loading'); const stateResult = document.getElementById('state-result'); const stateHistory = document.getElementById('state-history'); const urlInput = document.getElementById('url-input'); const btnPaste = document.getElementById('btn-paste'); const btnAnalyze = document.getElementById('btn-analyze'); const videoThumb = document.getElementById('video-thumb'); const videoTitle = document.getElementById('video-title'); const videoUploader = document.getElementById('video-uploader'); const videoDuration = document.getElementById('video-duration'); const btnDropdownToggle = document.getElementById('btn-dropdown-toggle'); const qualityDropdown = document.getElementById('quality-dropdown'); const videoOptionsList = document.getElementById('video-options-list'); const audioOptionsList = document.getElementById('audio-options-list'); const selectedQualityBadge = document.getElementById('selected-quality-badge'); const selectedSizeText = document.getElementById('selected-size-text'); const btnMainDownload = document.getElementById('btn-main-download'); const btnReset = document.getElementById('btn-reset'); const toast = document.getElementById('toast'); const iconYoutube = document.getElementById('icon-youtube'); const iconTiktok = document.getElementById('icon-tiktok'); const iconFacebook = document.getElementById('icon-facebook'); const iconInstagram = document.getElementById('icon-instagram'); const updatePlatformIcons = (url) => { if (!iconYoutube || !iconTiktok) return; iconYoutube.classList.add('hidden'); iconTiktok.classList.add('hidden'); if (iconFacebook) iconFacebook.classList.add('hidden'); if (iconInstagram) iconInstagram.classList.add('hidden'); if (!url) return; if (url.includes('youtube.com') || url.includes('youtu.be')) { iconYoutube.classList.remove('hidden'); } else if (url.includes('tiktok.com')) { iconTiktok.classList.remove('hidden'); } else if (url.includes('facebook.com') || url.includes('fb.watch')) { if (iconFacebook) iconFacebook.classList.remove('hidden'); } else if (url.includes('instagram.com')) { if (iconInstagram) iconInstagram.classList.remove('hidden'); } }; const btnShowHistory = document.getElementById('btn-show-history'); const btnHeaderBack = document.getElementById('btn-header-back'); const appLogo = document.getElementById('app-logo'); const btnHistoryBack = document.getElementById('btn-history-back'); const btnClearHistory = document.getElementById('btn-clear-history'); const historyList = document.getElementById('history-list'); const downloadStatusContainer = document.getElementById('download-status-container'); const progressBarFill = document.getElementById('progress-bar-fill'); const downloadStatusLabel = document.getElementById('download-status-label'); const downloadPercentage = document.getElementById('download-percentage'); let currentVideoData = null; let selectedFormat = null; const formatDuration = (seconds) => { if (!seconds) return '0:00'; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${mins}:${secs.toString().padStart(2, '0')}`; }; chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => { const tab = tabs[0]; if (tab && tab.url) { const url = tab.url; const isYouTubeVideo = url.includes('youtube.com/watch') || url.includes('youtu.be/'); const isTikTokVideo = url.includes('tiktok.com/') && (url.includes('/video/') || url.includes('/v/')); const isFacebookVideo = url.includes('facebook.com') || url.includes('fb.watch'); const isInstagramVideo = url.includes('instagram.com'); if (isYouTubeVideo || isTikTokVideo || isFacebookVideo || isInstagramVideo) { if (!url.includes('/search') && !url.includes('/explore')) { urlInput.value = url; updatePlatformIcons(url); showToast('Video link pulled from tab!'); } } else if (url.includes('tiktok.com')) { showToast('Scanning feed for video...'); chrome.scripting.executeScript({ target: { tabId: tab.id }, func: () => { const videoLinks = Array.from(document.querySelectorAll('a[href*="/video/"]')); let bestLink = null; let minDistance = Infinity; const viewportCenter = window.innerHeight / 2; for (const link of videoLinks) { const rect = link.getBoundingClientRect(); if (rect.width === 0 || rect.height === 0) continue; const elementCenter = rect.top + (rect.height / 2); const distance = Math.abs(viewportCenter - elementCenter); if (distance < minDistance) { minDistance = distance; bestLink = link; } } return bestLink ? bestLink.href : null; } }, (results) => { if (results && results[0] && results[0].result) { urlInput.value = results[0].result; showToast('Video found in feed!'); } else { } }); } } }); const getCookies = (url) => { return new Promise((resolve) => { try { const urlObj = new URL(url); let domain = urlObj.hostname; if (domain.includes('youtube.com')) domain = '.youtube.com'; else if (domain.includes('tiktok.com')) domain = '.tiktok.com'; chrome.cookies.getAll({ domain: domain }, (cookies) => { resolve(cookies || []); }); } catch (e) { console.warn("Cookie fetch error:", e); resolve([]); } }); }; const showToast = (text, duration = 3000) => { toast.textContent = text; toast.classList.remove('hidden'); toast.style.opacity = '0'; setTimeout(() => { toast.style.transition = 'opacity 0.3s'; toast.style.opacity = '1'; }, 10); setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.classList.add('hidden'), 300); }, duration); }; const setState = (state) => { [stateInput, stateLoading, stateResult, stateHistory].forEach(el => el.classList.add('hidden')); let target; switch (state) { case 'input': target = stateInput; break; case 'loading': target = stateLoading; break; case 'result': target = stateResult; break; case 'history': target = stateHistory; renderHistory(); break; default: target = stateInput; } target.classList.remove('hidden'); target.animate([ { opacity: 0, transform: 'translateY(10px)' }, { opacity: 1, transform: 'translateY(0)' } ], { duration: 300, easing: 'ease-out' }); if (state === 'input') { btnHeaderBack.classList.add('hidden'); } else { btnHeaderBack.classList.remove('hidden'); } }; const saveToHistory = async (videoData, format) => { const historyItem = { id: Date.now(), title: videoData.title, thumbnail: videoData.thumbnail, quality: format.quality, type: format.type, date: new Date().toLocaleDateString(), timestamp: Date.now() }; const { downloadHistory = [] } = await chrome.storage.local.get('downloadHistory'); const newHistory = [historyItem, ...downloadHistory].slice(0, 10); await chrome.storage.local.set({ downloadHistory: newHistory }); }; const renderHistory = async () => { const { downloadHistory = [] } = await chrome.storage.local.get('downloadHistory'); historyList.innerHTML = ''; if (downloadHistory.length === 0) { const emptyDiv = document.createElement('div'); emptyDiv.className = 'empty-history'; const p = document.createElement('p'); p.textContent = 'No downloads yet.'; emptyDiv.appendChild(p); historyList.appendChild(emptyDiv); return; } downloadHistory.forEach(item => { const div = document.createElement('div'); div.className = 'history-item'; const img = document.createElement('img'); img.src = item.thumbnail; img.className = 'hist-thumb'; const infoDiv = document.createElement('div'); infoDiv.className = 'hist-info'; const titleSpan = document.createElement('span'); titleSpan.className = 'hist-title'; titleSpan.textContent = item.title; const metaDiv = document.createElement('div'); metaDiv.className = 'hist-meta'; const qualitySpan = document.createElement('span'); qualitySpan.textContent = item.quality; const separatorSpan = document.createElement('span'); separatorSpan.textContent = 'â€¢'; const dateSpan = document.createElement('span'); dateSpan.textContent = item.date; metaDiv.appendChild(qualitySpan); metaDiv.appendChild(separatorSpan); metaDiv.appendChild(dateSpan); infoDiv.appendChild(titleSpan); infoDiv.appendChild(metaDiv); div.appendChild(img); div.appendChild(infoDiv); historyList.appendChild(div); }); }; const animateProgress = () => { let progress = 0; downloadStatusContainer.classList.remove('hidden'); btnMainDownload.classList.add('hidden'); const interval = setInterval(() => { if (progress >= 95) { clearInterval(interval); return; } progress += Math.random() * 5; if (progress > 95) progress = 95; progressBarFill.style.width = `${progress}%`; downloadPercentage.textContent = `${Math.round(progress)}%`; }, 800); return interval; }; const resetProgress = () => { progressBarFill.style.width = '0%'; downloadPercentage.textContent = '0%'; downloadStatusContainer.classList.add('hidden'); btnMainDownload.classList.remove('hidden'); }; const populateOptions = (formats) => { videoOptionsList.innerHTML = ''; audioOptionsList.innerHTML = ''; const videoFormats = formats.filter(f => f.type === 'video'); const audioFormat = formats.find(f => f.type === 'audio'); videoFormats.forEach((fmt, index) => { const div = document.createElement('div'); div.className = 'option-item'; if (index === 0) div.classList.add('selected'); const isHighQuality = fmt.height >= 1080; const qualityLabel = isHighQuality ? `${fmt.quality} ${fmt.quality.includes('2160') ? '4K' : 'HD'}` : fmt.quality; const nameSpan = document.createElement('span'); nameSpan.className = 'opt-name'; nameSpan.textContent = qualityLabel; const sizeSpan = document.createElement('span'); sizeSpan.className = 'opt-size'; sizeSpan.textContent = fmt.size_text; div.appendChild(nameSpan); div.appendChild(sizeSpan); div.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected')); div.classList.add('selected'); updateSelectedFormat(fmt); qualityDropdown.classList.add('hidden'); }); videoOptionsList.appendChild(div); if (index === 0) updateSelectedFormat(fmt); }); if (audioFormat) { const div = document.createElement('div'); div.className = 'option-item'; const nameSpan = document.createElement('span'); nameSpan.className = 'opt-name'; nameSpan.textContent = 'MP3 Audio'; const sizeSpan = document.createElement('span'); sizeSpan.className = 'opt-size'; sizeSpan.textContent = audioFormat.size_text; div.appendChild(nameSpan); div.appendChild(sizeSpan); div.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected')); div.classList.add('selected'); updateSelectedFormat(audioFormat); qualityDropdown.classList.add('hidden'); }); audioOptionsList.appendChild(div); } }; const updateSelectedFormat = (fmt) => { selectedFormat = fmt; selectedQualityBadge.textContent = fmt.type === 'audio' ? 'MP3' : fmt.quality; selectedSizeText.textContent = fmt.size_text; }; const handleAnalyze = async () => { const url = urlInput.value.trim(); if (!url) { showToast('Please paste a video URL'); return; } setState('loading'); try { const cookies = await getCookies(url); const userAgent = navigator.userAgent; const response = await fetch(`${BASE_URL}/analyze`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url, cookies, userAgent }) }); const data = await response.json(); if (data.error) throw new Error(data.error); if (data.info && data.info.error) throw new Error(data.info.error); currentVideoData = data; videoThumb.src = data.thumbnail; videoTitle.textContent = data.title; videoUploader.textContent = data.uploader || 'Unknown Creator'; videoDuration.textContent = formatDuration(data.duration); populateOptions(data.formats); setState('result'); } catch (err) { console.error(err); showToast(err.message || 'Analysis failed. Check connection.'); setState('input'); } }; const handleDownload = async () => { if (!selectedFormat || !currentVideoData) return; downloadStatusLabel.textContent = 'Preparing...'; const progressInterval = animateProgress(); try { const cookies = await getCookies(currentVideoData.webpage_url); downloadStatusLabel.textContent = 'Downloading...'; const response = await chrome.runtime.sendMessage({ action: 'download', url: currentVideoData.webpage_url, format: selectedFormat.type, quality: selectedFormat.height || selectedFormat.id, format_id: selectedFormat.id, cookies: cookies, userAgent: navigator.userAgent }); clearInterval(progressInterval); if (response && response.success) { progressBarFill.style.width = '100%'; downloadPercentage.textContent = '100%'; downloadStatusLabel.textContent = 'Completed!'; showToast('Download started!'); await saveToHistory(currentVideoData, selectedFormat); setTimeout(() => { resetProgress(); }, 2000); } else { resetProgress(); showToast(response.error || 'Download error'); } } catch (err) { clearInterval(progressInterval); resetProgress(); console.error(err); showToast('Error: ' + (err.message || 'Communication error')); } }; btnPaste.addEventListener('click', async () => { urlInput.focus(); try { const text = await navigator.clipboard.readText(); if (text) { urlInput.value = text; updatePlatformIcons(text); showToast('Link pasted!'); } else { showToast('Clipboard is empty'); } } catch (err) { console.error('navigator.clipboard error:', err); try { urlInput.select(); const success = document.execCommand('paste'); if (success) { showToast('Link pasted!'); } else { throw new Error('execCommand paste failed'); } } catch (fallbackErr) { console.error('Paste fallback failed:', fallbackErr); showToast('Manual paste needed (Ctrl+V)'); } } }); btnAnalyze.addEventListener('click', handleAnalyze); urlInput.addEventListener('input', (e) => { updatePlatformIcons(e.target.value); }); urlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAnalyze(); }); btnDropdownToggle.addEventListener('click', (e) => { e.stopPropagation(); qualityDropdown.classList.toggle('hidden'); }); document.addEventListener('click', () => { qualityDropdown.classList.add('hidden'); }); btnMainDownload.addEventListener('click', (e) => { e.stopPropagation(); handleDownload(); }); btnReset.addEventListener('click', () => { urlInput.value = ''; updatePlatformIcons(''); setState('input'); }); btnShowHistory.addEventListener('click', () => setState('history')); btnHistoryBack.addEventListener('click', () => setState(currentVideoData ? 'result' : 'input')); btnHeaderBack.addEventListener('click', () => { if (!stateHistory.classList.contains('hidden')) { setState(currentVideoData ? 'result' : 'input'); } else { setState('input'); currentVideoData = null; } }); btnClearHistory.addEventListener('click', async () => { await chrome.storage.local.set({ downloadHistory: [] }); renderHistory(); showToast('History cleared'); }); });